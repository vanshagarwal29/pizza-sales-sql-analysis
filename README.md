CREATE DATABASE PIZZAS;
-- USE DATABASE 
USE PIZZAS;
-- SHOW TABLE 
SHOW TABLES;
-- EXISTING TABLE DATA 
SELECT * FROM pizzas;
SELECT * FROM pizza_types;
 
-- CREATE TABLE FIRST FOR LARGE DATA 
CREATE TABLE ORDERS
(ORDER_ID INT NOT NULL,
ORDER_DATE DATE NOT NULL,
ORDER_TIME TIME NOT NULL,
PRIMARY KEY (ORDER_ID));

-- TO CHECK ORDERS DATA 
SELECT * FROM ORDERS;

-- CREATE TABLE ORDER_DETAILS
CREATE TABLE ORDER_DETAILS
(ORDER_DETAILS_ID INT NOT NULL,
ORDER_ID INT NOT NULL,
PIZZA_ID TEXT NOT NULL,
QUANTITY INT NOT NULL,
PRIMARY KEY (ORDER_DETAILS_ID));

SELECT * FROM ORDER_DETAILS;
-- BASIC QUESTION
-- Q:1 Retrieve the total number of orders placed.
SELECT COUNT(ORDER_ID) AS TOTAL_ORDER 
FROM ORDERS;

-- Q:2 Calculate the total revenue generated from pizza sales. 
SELECT 
    ROUND(SUM(ORDER_DETAILS.QUANTITY * PIZZAS.PRICE),
            2) AS TOTAL_SALES
FROM
    ORDER_DETAILS
        JOIN
    PIZZAS ON PIZZAS.PIZZA_ID = ORDER_DETAILS.PIZZA_ID;
    
-- Q:3 Identify the highest-priced pizza.
SELECT 
    PIZZAS.PRICE, PIZZA_TYPES.NAME
FROM
    PIZZAS
        JOIN
    PIZZA_TYPES ON PIZZA_TYPES.PIZZA_TYPE_ID = PIZZAS.PIZZA_TYPE_ID
ORDER BY PIZZAS.PRICE DESC
LIMIT 1;

-- Q:4 Identify the most common pizza size ordered.
SELECT 
    PIZZAS.SIZE,
    COUNT(ORDER_DETAILS.ORDER_DETAILS_ID) AS ORDER_COUNT
FROM
    PIZZAS
        JOIN
    ORDER_DETAILS ON PIZZAS.PIZZA_ID = ORDER_DETAILS.PIZZA_ID
GROUP BY PIZZAS.SIZE
ORDER BY ORDER_COUNT DESC
LIMIT 3;

-- Q:5 List the top 5 most ordered pizza types along with their quantities.
SELECT 
    PIZZA_TYPES.NAME, SUM(ORDER_DETAILS.QUANTITY) AS QUANTITY
FROM
    PIZZA_TYPES
        JOIN
    PIZZAS ON PIZZA_TYPES.PIZZA_TYPE_ID = PIZZAS.PIZZA_TYPE_ID
        JOIN
    ORDER_DETAILS ON ORDER_DETAILS.PIZZA_ID = PIZZAS.PIZZA_ID
GROUP BY PIZZA_TYPES.NAME
ORDER BY QUANTITY DESC
LIMIT 5;


-- INTERMIDIATE QUESTION 
-- Q:1 Join the necessary tables to find the total quantity of each pizza category ordered.
SELECT PIZZA_TYPES.CATEGORY , SUM(ORDER_DETAILS.QUANTITY) AS QUANTITY 
FROM PIZZA_TYPES JOIN PIZZAS 
ON PIZZA_TYPES.PIZZA_TYPE_ID =PIZZAS.PIZZA_TYPE_ID
JOIN ORDER_DETAILS 
ON ORDER_DETAILS.PIZZA_ID =PIZZAS.PIZZA_ID
GROUP BY CATEGORY ORDER BY QUANTITY DESC ;

-- Q:2 Determine the distribution of orders by hour of the day.
SELECT HOUR(ORDER_TIME) AS HOUR ,COUNT(ORDER_ID) AS ORDER_COUNT FROM ORDERS
GROUP BY HOUR(ORDER_TIME);

-- Q:3 Join relevant tables to find the category-wise distribution of pizzas.
SELECT CATEGORY,COUNT(NAME) FROM PIZZA_TYPES
GROUP BY CATEGORY;

-- Q:4 Group the orders by date and calculate the average number of pizzas ordered per day.
SELECT 
    ROUND(AVG(QUANTITY), 2)
FROM
    (SELECT 
        ORDERS.ORDER_DATE, SUM(ORDER_DETAILS.QUANTITY) AS QUANTITY
    FROM
        ORDERS
    JOIN ORDER_DETAILS ON ORDERS.ORDER_ID = ORDER_DETAILS.ORDER_ID
    GROUP BY ORDERS.ORDER_DATE) AS QUANTITY_ORDER;
    
-- Q:5 Determine the top 3 most ordered pizza types based on revenue.
SELECT 
    PIZZA_TYPES.NAME,
    SUM(ORDER_DETAILS.QUANTITY * PIZZAS.PRICE) AS REVENUE
FROM
    PIZZA_TYPES
        JOIN
    PIZZAS ON PIZZAS.PIZZA_TYPE_ID = PIZZA_TYPES.PIZZA_TYPE_ID
        JOIN
    ORDER_DETAILS ON PIZZAS.PIZZA_ID = ORDER_DETAILS.PIZZA_ID
GROUP BY PIZZA_TYPES.NAME
ORDER BY REVENUE DESC
LIMIT 3;



-- ADVANCE QUESTION 

-- Q:1 Determine the top 3 most ordered pizza types based on revenue for each pizza category.

SELECT NAME,REVENUE FROM 
(SELECT CATEGORY,NAME,REVENUE,
RANK() OVER(PARTITION BY CATEGORY ORDER BY REVENUE DESC) AS RN 
FROM 
(SELECT PIZZA_TYPES.CATEGORY ,PIZZA_TYPES.NAME ,SUM(ORDER_DETAILS.QUANTITY*PIZZAS.PRICE) AS REVENUE FROM
PIZZA_TYPES JOIN PIZZAS
ON PIZZA_TYPES.PIZZA_TYPE_ID =PIZZAS.PIZZA_TYPE_ID
JOIN ORDER_DETAILS
ON ORDER_DETAILS.PIZZA_ID=PIZZAS.PIZZA_ID
GROUP BY PIZZA_TYPES.CATEGORY ,PIZZA_TYPES.NAME) AS A) AS B
WHERE RN <= 3;

-- Q:2 Analyze the cumulative revenue generated over time.

SELECT 
    ORDER_DATE,
    SUM(REVENUE) OVER (ORDER BY ORDER_DATE) AS CUM_REVENUE
FROM
(
    SELECT 
        ORDERS.ORDER_DATE,
        SUM(ORDER_DETAILS.QUANTITY * PIZZAS.PRICE) AS REVENUE
    FROM 
        ORDERS
        JOIN ORDER_DETAILS ON ORDERS.ORDER_ID = ORDER_DETAILS.ORDER_ID
        JOIN PIZZAS ON PIZZAS.PIZZA_ID = ORDER_DETAILS.PIZZA_ID
    GROUP BY 
        ORDERS.ORDER_DATE
) AS SALE;

-- Q:3 Calculate the percentage contribution of each pizza type to total revenue.
SELECT 
    PIZZA_TYPES.CATEGORY,
    ROUND(SUM(ORDER_DETAILS.QUANTITY * PIZZAS.PRICE) / (SELECT 
                    ROUND(SUM(ORDER_DETAILS.QUANTITY * PIZZAS.PRICE),
                                2) AS TOTAL_SALES
                FROM
                    ORDER_DETAILS
                        JOIN
                    PIZZAS ON PIZZAS.PIZZA_ID = ORDER_DETAILS.PIZZA_ID) * 100,
            2) AS REVENUE
FROM
    PIZZA_TYPES
        JOIN
    PIZZAS ON PIZZA_TYPES.PIZZA_TYPE_ID = PIZZAS.PIZZA_TYPE_ID
        JOIN
    ORDER_DETAILS ON ORDER_DETAILS.PIZZA_ID = PIZZAS.PIZZA_ID
GROUP BY PIZZA_TYPES.CATEGORY
ORDER BY REVENUE DESC

